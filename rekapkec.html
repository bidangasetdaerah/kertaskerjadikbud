<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard KIB B - Expand Row</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 10px; background-color: #f9fafb; }
    h1 { font-size: 1.5rem; margin-bottom: 10px; text-align: center; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; vertical-align: top; }
    th { background-color: #3b82f6; color: white; font-size: 0.8rem; }
    tr.expand-row td { background: #f1f5f9; font-style: italic; }
    .clickable { cursor: pointer; background: #eef2ff; }
    .clickable:hover { background: #c7d2fe; }
  </style>
</head>
<body>

  <h1>Dashboard KIB B - Rekap Per Kecamatan</h1>

  <table id="rekapTable">
    <thead>
      <tr>
        <th>Kecamatan</th>
        <th>Ditemukan</th>
        <th>Tidak Ditemukan</th>
        <th>Baik</th>
        <th>Rusak Ringan</th>
        <th>Rusak Berat</th>
        <th>Nilai Perolehan (Rp)</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr style="font-weight:bold; background:#e5e7eb;">
        <td>Total</td>
        <td id="totalDitemukan">0</td>
        <td id="totalTidakDitemukan">0</td>
        <td id="totalBaik">0</td>
        <td id="totalRusakRingan">0</td>
        <td id="totalRusakBerat">0</td>
        <td id="totalNilai">0</td>
      </tr>
    </tfoot>
  </table>

  <script>
  const kecamatanEndpoints = {
   "Banawa": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRd8vIhHDUbmD6I2aXLX7-_Ysemt2aXA__wKNGoKN0XWWSWCScv5aSmx06H0xkl8g/pub?gid=1917777904&single=true&output=csv",
    "Banawa Tengah": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRnykw5e_i3dwBIeTua-mpFExEJ4w6hROJ5F6OUHiiGpbtunldeKgXlhN_G-D1V8w/pub?gid=1454720232&single=true&output=csv",
    "Banawa Selatan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDJK33BtCz7KEi6DWgqheZBrcdgK0X9Pw1r28u5ec1MK-I-kP-QOqrsY0G2OnEQ/pub?gid=708970016&single=true&output=csv",
    "Rio Pakava": "https://docs.google.com/spreadsheets/d/1_8YllqyTXGDZZCVeozFKAhGru2WS15Bp/export?format=csv",
    "Pinembani": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQshgCYmG0DHxcwLUzhtUamXTYnWb8tR7WQwnJq9k7ldFz_JhV4GHDE-k_dMO_pSA/pub?gid=1860451546&single=true&output=csv",
    "Tanantovea": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR3MhjBMD3q8UIfOTdAUOHKMdeGcwr3y2YQGFcDmHDd0IVsOsAECl511LsNJ9ynow9cmY4yBpP1jENa/pub?gid=1200528899&single=true&output=csv",
    "Labuan": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7WqNsmpUBIy0-lVm2JdGg1KUKwNgQPpbSyDuuFDwB1aGPY8gsZSBWmxIgiOeJNA/pub?gid=1615242439&single=true&output=csv",
    "Sindue": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2sjcmJjTCYD3p6-7pDQTmm3mCVphZIP2-5DGZOHxStucexMcdqPVsfsbnDouFcA/pub?gid=1920885371&single=true&output=csv",
    "Sindue Tombusabora": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRYHOyrOQ_hNjC1L1FoIMVbbWES0dPGb1OaU6V--PV_lm0O97IHFvtPRhgRNXn_dA/pub?gid=1974330298&single=true&output=csv",
    "Sindue Tobata": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIbvzs-jZRcf1z0uV_Ahwh6dNdBgBHw66T358D9wd0-DHimDs8r4ajCvZwLa8Srg/pub?gid=801352666&single=true&output=csv",
    "Sirenja": "https://docs.google.com/spreadsheets/d/e/2PACX-1vROhU6H6reNQxHKsAmYYgfcaSZyis1vALTmBkYhjAp7BGX_wNdA2cVdgOjFQIIgjQ/pub?output=csv",
    "Balaesang": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQIf6mV6qgS6fmRe3jz305N8wCDdKWJcKKWSxHtybbo7xoERx15unD-x4rgyFxF-g/pub?gid=1401841928&single=true&output=csv",
    "Balaesang Tanjung": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQRojLHXJ4W6IEdiNn34kZrMgr5QvPZllm85-sbgD0WxjG6vFMUMQz3QzzGnM-7pw/pub?gid=820099832&single=true&output=csv",
    "Dampelas": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR_BmCgfv-HOMRKzNMZ1aHL05CZsR7Ie0VZGRJTD29tX1C-ANiKASW1hB_PM69WuQ/pub?gid=1489077321&single=true&output=csv",
    "Sojol": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT64A3AbrmT4TK8fLj5ctUc3LLMESXVTOuw3nBd2qRTEFIljaxTBW3-Z5u4w7W2Ng/pub?gid=1781390946&single=true&output=csv",
    "Sojol Utara": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT41KwECicPb2EY8d8BP1f73RM3dhVWYDOxpaFlHZluKFy9owLzyVX7N7mIUm37Tw/pub?gid=502544387&single=true&output=csv"
  };

  let sekolahPerKecamatan = {};

  async function fetchData(url) {
    return new Promise((resolve) => {
      if (!url) return resolve([]);
      Papa.parse(url, {
        download: true,
        header: true,
        complete: (results) => resolve(results.data)
      });
    });
  }

  async function updateRekapKecamatan() {
    const tbody = document.querySelector("#rekapTable tbody");
    tbody.innerHTML = "";

    let total = { Ditemukan:0, Tidak:0, Baik:0, Ringan:0, Berat:0, Nilai:0 };

    for (const [nama, url] of Object.entries(kecamatanEndpoints)) {
      const data = await fetchData(url);
      let ditemukan=0, tidak=0, baik=0, ringan=0, berat=0, nilai=0;

      let sekolahSet = new Set();
      data.forEach(row=>{
        // ambil dari kolom "Status Penggunaan"
        const sekolah = row["Status Penggunaan"];
        if (sekolah) sekolahSet.add(sekolah.trim());
      });
      sekolahPerKecamatan[nama] = Array.from(sekolahSet);

      data.forEach(row=>{
        const k = row["Konfirmasi Keberadaan"] || "Tidak Ditemukan";
        const c = row["Kondisi"] || "Baik";
        const v = parseFloat(row["Harga Perolehan"] || row["Nilai Perolehan"] || 0);

        if(k==="Ditemukan") ditemukan++; else tidak++;
        if(c==="Baik") baik++;
        else if(c==="Rusak Ringan") ringan++;
        else if(c==="Rusak Berat") berat++;
        nilai += v;
      });

      total.Ditemukan+=ditemukan;
      total.Tidak+=tidak;
      total.Baik+=baik;
      total.Ringan+=ringan;
      total.Berat+=berat;
      total.Nilai+=nilai;

      const tr = document.createElement("tr");
      tr.classList.add("clickable");
      tr.innerHTML = `<td>${nama}</td>
                      <td>${ditemukan}</td>
                      <td>${tidak}</td>
                      <td>${baik}</td>
                      <td>${ringan}</td>
                      <td>${berat}</td>
                      <td>${nilai.toLocaleString("id-ID")}</td>`;

      tr.addEventListener("click", ()=>{
        toggleExpandRow(tr, nama);
      });

      tbody.appendChild(tr);
    }

    document.getElementById("totalDitemukan").textContent = total.Ditemukan;
    document.getElementById("totalTidakDitemukan").textContent = total.Tidak;
    document.getElementById("totalBaik").textContent = total.Baik;
    document.getElementById("totalRusakRingan").textContent = total.Ringan;
    document.getElementById("totalRusakBerat").textContent = total.Berat;
    document.getElementById("totalNilai").textContent = total.Nilai.toLocaleString("id-ID");
  }

  function toggleExpandRow(tr, kecamatan) {
    if (tr.nextSibling && tr.nextSibling.classList && tr.nextSibling.classList.contains("expand-row")) {
      tr.nextSibling.remove();
      return;
    }
    const existing = document.querySelector(".expand-row");
    if (existing) existing.remove();

    const expandTr = document.createElement("tr");
    expandTr.classList.add("expand-row");
    const td = document.createElement("td");
    td.colSpan = 7;

    const sekolahList = sekolahPerKecamatan[kecamatan] || [];
    if (sekolahList.length === 0) {
      td.innerHTML = "<em>Tidak ada sekolah yang mengisi data</em>";
    } else {
      td.innerHTML = "<strong>Daftar Sekolah:</strong><br>" + sekolahList.join("<br>");
    }

    expandTr.appendChild(td);
    tr.parentNode.insertBefore(expandTr, tr.nextSibling);
  }

  updateRekapKecamatan();
  setInterval(updateRekapKecamatan, 300000);
  </script>

</body>
</html>
