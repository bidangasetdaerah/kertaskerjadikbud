<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard KIB B - Responsive</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  body { font-family: sans-serif; margin: 10px; background-color: #f9fafb; }
  h1 { font-size: 1.5rem; margin-bottom: 10px; text-align: center; }
  h2 { font-size: 1.1rem; margin-top: 15px; }
  label { display: block; margin-top: 10px; font-size: 0.9rem; }
  select, input { width: 100%; padding: 6px; margin-top: 4px; border-radius: 4px; border: 1px solid #ccc; }
  
  .dashboard { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
  .chart-container, table { background: white; border-radius: 8px; padding: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  .chart-container { flex: 1 1 300px; }
  canvas { width: 100% !important; height: 250px !important; }

  table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; }
  th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
  th { background-color: #3b82f6; color: white; font-size: 0.8rem; }
  
  .pagination { margin-top: 10px; text-align: center; }
  .pagination button { margin: 0 2px; padding: 4px 8px; border-radius: 4px; border: none; background-color: #3b82f6; color: white; font-size: 0.8rem; cursor: pointer; }
  .pagination button.disabled { background-color: #cbd5e1; cursor: not-allowed; }

  @media (max-width: 768px) {
    .dashboard { flex-direction: column; }
    canvas { height: 200px !important; }
  }
</style>
</head>
<body>

<h1>Dashboard KIB B - DINAS PENDIDIKAN</h1>

<label for="filterKecamatan">Filter Kecamatan:</label>
<select id="filterKecamatan">
  <option value="">--Pilih Kecamatan--</option>
  <!-- ... semua opsi kecamatan seperti sebelumnya ... -->
</select>

<label for="searchBarang">Cari Nama Barang:</label>
<input type="text" id="searchBarang" placeholder="Masukkan nama barang...">

<div class="dashboard">
  <div class="chart-container">
    <h2>Konfirmasi Keberadaan</h2>
    <canvas id="chartKonfirmasi"></canvas>
  </div>
  <div class="chart-container">
    <h2>Kondisi Barang</h2>
    <canvas id="chartKondisi"></canvas>
  </div>
</div>

<div class="chart-container">
  <h2>Data Kecamatan (Tabel)</h2>
  <table id="dataTable">
    <thead>
      <tr>
        <th>No</th>
        <th>Nama Barang</th>
        <th>Konfirmasi</th>
        <th>Kondisi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="pagination" id="pagination"></div>
</div>

<div class="chart-container">
  <h2>Rekap Kabupaten (Tabel)</h2>
  <table id="rekapKecamatanTable">
    <thead>
      <tr>
        <th>Kecamatan</th>
        <th>Total Barang</th>
        <th>Ditemukan</th>
        <th>Tidak Ditemukan</th>
        <th>Baik</th>
        <th>Rusak Ringan</th>
        <th>Rusak Berat</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="dashboard">
  <div class="chart-container">
    <h2>Rekap Kabupaten - Konfirmasi</h2>
    <canvas id="rekapKonfirmasiChart"></canvas>
  </div>
  <div class="chart-container">
    <h2>Rekap Kabupaten - Kondisi</h2>
    <canvas id="rekapKondisiChart"></canvas>
  </div>
</div>

<script>
let currentData = [];
let filteredData = [];
let currentPage = 1;
const rowsPerPage = 8;
let chartKonfirmasi, chartKondisi;
let rekapKonfirmasiChart, rekapKondisiChart;

const kecamatanOptions = Array.from(document.querySelectorAll("#filterKecamatan option"))
  .filter(opt => opt.value && opt.dataset.endpoint)
  .map(opt => ({ nama: opt.value, url: opt.dataset.endpoint }));

function updateDashboard() {
  const searchValue = document.getElementById("searchBarang").value.toLowerCase();
  filteredData = currentData.filter(row => (row["Nama Barang"] || "").toLowerCase().includes(searchValue));
  currentPage = 1;
  renderTablePage(currentPage);
  renderCharts(filteredData);
}

function renderTablePage(page) {
  const tableBody = document.querySelector("#dataTable tbody");
  tableBody.innerHTML = "";
  const start = (page - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pageData = filteredData.slice(start, end);

  pageData.forEach((row, index) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${start + index + 1}</td>
      <td>${row["Nama Barang"] || "-"}</td>
      <td>${row["Konfirmasi Keberadaan"] || "Tidak Ditemukan"}</td>
      <td>${row["Kondisi"] || "Baik"}</td>
    `;
    tableBody.appendChild(tr);
  });
  renderPagination();
}

function renderPagination() {
  const totalPages = Math.ceil(filteredData.length / rowsPerPage);
  const paginationDiv = document.getElementById("pagination");
  paginationDiv.innerHTML = "";
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.disabled = i === currentPage;
    if(i === currentPage) btn.classList.add("disabled");
    btn.addEventListener("click", () => { currentPage = i; renderTablePage(currentPage); });
    paginationDiv.appendChild(btn);
  }
}

function renderCharts(data) {
  const konfirmasiCounts = { Ditemukan: 0, "Tidak Ditemukan": 0 };
  const kondisiCounts = { Baik: 0, "Rusak Ringan": 0, "Rusak Berat": 0 };

  data.forEach(row => {
    const konfirmasi = row["Konfirmasi Keberadaan"] || "Tidak Ditemukan";
    const kondisi = row["Kondisi"] || "Baik";
    if (konfirmasiCounts[konfirmasi] !== undefined) konfirmasiCounts[konfirmasi]++; 
    if (kondisiCounts[kondisi] !== undefined) kondisiCounts[kondisi]++; 
  });

  const konfirmasiCtx = document.getElementById('chartKonfirmasi').getContext('2d');
  if(chartKonfirmasi) chartKonfirmasi.destroy();
  chartKonfirmasi = new Chart(konfirmasiCtx, {
    type: 'pie',
    data: {
      labels: Object.keys(konfirmasiCounts),
      datasets: [{ data: Object.values(konfirmasiCounts), backgroundColor: ['#3b82f6','#ef4444'] }]
    }
  });

  const kondisiCtx = document.getElementById('chartKondisi').getContext('2d');
  if(chartKondisi) chartKondisi.destroy();
  chartKondisi = new Chart(kondisiCtx, {
    type: 'doughnut',
    data: {
      labels: Object.keys(kondisiCounts),
      datasets: [{ data: Object.values(kondisiCounts), backgroundColor: ['#10b981','#fbbf24','#ef4444'] }]
    }
  });
}

function updateRekapKecamatan() {
  const tbody = document.querySelector("#rekapKecamatanTable tbody");
  tbody.innerHTML = "";

  // total kabupaten
  let totalKonfirmasi = { Ditemukan: 0, "Tidak Ditemukan": 0 };
  let totalKondisi = { Baik: 0, "Rusak Ringan": 0, "Rusak Berat": 0 };

  kecamatanOptions.forEach(kec => {
    Papa.parse(kec.url, {
      download: true,
      header: true,
      complete: function(results) {
        const data = results.data;
        let total = data.length;
        let ditemukan = data.filter(r => r["Konfirmasi Keberadaan"] === "Ditemukan").length;
        let tidak = total - ditemukan;
        let baik = data.filter(r => r["Kondisi"] === "Baik").length;
        let ringan = data.filter(r => r["Kondisi"] === "Rusak Ringan").length;
        let berat = data.filter(r => r["Kondisi"] === "Rusak Berat").length;

        // update total kabupaten
        totalKonfirmasi["Ditemukan"] += ditemukan;
        totalKonfirmasi["Tidak Ditemukan"] += tidak;
        totalKondisi["Baik"] += baik;
        totalKondisi["Rusak Ringan"] += ringan;
        totalKondisi["Rusak Berat"] += berat;

        // isi tabel per kecamatan
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${kec.nama}</td>
          <td>${total}</td>
          <td>${ditemukan}</td>
          <td>${tidak}</td>
          <td>${baik}</td>
          <td>${ringan}</td>
          <td>${berat}</td>
        `;
        tbody.appendChild(tr);

        // setelah semua selesai, update grafik kabupaten
        if (tbody.rows.length === kecamatanOptions.length) {
          renderRekapCharts(totalKonfirmasi, totalKondisi);
        }
      }
    });
  });
}

function renderRekapCharts(totalKonfirmasi, totalKondisi) {
  const konfirmasiCtx = document.getElementById('rekapKonfirmasiChart').getContext('2d');
  if(rekapKonfirmasiChart) rekapKonfirmasiChart.destroy();
  rekapKonfirmasiChart = new Chart(konfirmasiCtx, {
    type: 'pie',
    data: {
      labels: Object.keys(totalKonfirmasi),
      datasets: [{ data: Object.values(totalKonfirmasi), backgroundColor: ['#3b82f6','#ef4444'] }]
    }
  });

  const kondisiCtx = document.getElementById('rekapKondisiChart').getContext('2d');
  if(rekapKondisiChart) rekapKondisiChart.destroy();
  rekapKondisiChart = new Chart(kondisiCtx, {
    type: 'bar',
    data: {
      labels: Object.keys(totalKondisi),
      datasets: [{ data: Object.values(totalKondisi), backgroundColor: ['#10b981','#fbbf24','#ef4444'] }]
    },
    options: { plugins: { legend: { display: false } } }
  });
}

// filter per kecamatan
document.getElementById("filterKecamatan").addEventListener("change", function() {
  const url = this.selectedOptions[0].dataset.endpoint;
  if (!url) return alert("Data belum tersedia untuk kecamatan ini.");
  Papa.parse(url, {
    download: true,
    header: true,
    complete: function(results) {
      currentData = results.data;
      updateDashboard();
    }
  });
});

document.getElementById("searchBarang").addEventListener("input", updateDashboard);

// jalankan rekap pertama kali
updateRekapKecamatan();
// update tiap 10 detik
setInterval(updateRekapKecamatan, 10000);
</script>

</body>
</html>
