<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard KIB B - Responsive</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root {
    --primary:#3b82f6;
    --accent:#10b981;
    --warn:#fbbf24;
    --danger:#ef4444;
    --bg:#f9fafb;
    --muted:#cbd5e1;
  }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 10px; background-color: var(--bg); color:#0f172a;}
  h1 { font-size: 1.5rem; margin: 8px 0 12px; text-align: center; }
  label { display: block; margin-top: 10px; font-size: 0.9rem; }
  select, input { width: 100%; padding: 8px; margin-top: 6px; border-radius: 8px; border: 1px solid #e5e7eb; background: #fff; }
  
  .toolbar { display:flex; gap:10px; align-items:center; flex-wrap: wrap; margin-bottom:8px;}
  .btn { padding:8px 12px; border:none; border-radius:10px; background:var(--primary); color:white; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.08);}
  .btn.secondary { background:#111827; }
  .btn:disabled { background: var(--muted); cursor:not-allowed; }

  .dashboard { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
  .card, .chart-container, table { background: white; border-radius: 12px; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
  .chart-container { flex: 1 1 300px; min-width: 280px; }
  .chart-title { font-size:.95rem; font-weight:600; margin:0 0 6px;}
  canvas { width: 100% !important; height: 260px !important; }

  table { width: 100%; border-collapse: collapse; font-size: 0.86rem; overflow: hidden; }
  th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
  th { background-color: var(--primary); color: white; font-size: 0.8rem; position: sticky; top:0; }
  tbody tr:nth-child(odd){ background:#fafafa; }

  .pagination { margin-top: 10px; text-align: center; }
  .pagination button { margin: 0 2px; padding: 6px 10px; border-radius: 8px; border: none; background-color: var(--primary); color: white; font-size: 0.8rem; cursor: pointer; }
  .pagination button.disabled { background-color: var(--muted); cursor: not-allowed; }

  .muted { color:#6b7280; font-size:.82rem; }

  @media (max-width: 768px) {
    .dashboard { flex-direction: column; }
    canvas { height: 220px !important; }
  }
</style>
</head>
<body>

<h1>Dashboard KIB B - DINAS PENDIDIKAN</h1>

<div class="toolbar">
  <button id="rekapKabupatenBtn" class="btn">Lihat Rekap Kabupaten</button>
  <span id="statusInfo" class="muted"></span>
</div>

<label for="filterKecamatan">Filter Kecamatan:</label>
<select id="filterKecamatan">
  <option value="">--Pilih Kecamatan--</option>
  <option value="Banawa" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vRd8vIhHDUbmD6I2aXLX7-_Ysemt2aXA__wKNGoKN0XWWSWCScv5aSmx06H0xkl8g/pub?gid=1917777904&single=true&output=csv">Banawa</option>
  <option value="Banawa Tengah" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vRnykw5e_i3dwBIeTua-mpFExEJ4w6hROJ5F6OUHiiGpbtunldeKgXlhN_G-D1V8w/pub?gid=1454720232&single=true&output=csv">Banawa Tengah</option>
  <option value="Banawa Selatan" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vRhDJK33BtCz7KEi6DWgqheZBrcdgK0X9Pw1r28u5ec1MK-I-kP-QOqrsY0G2OnEQ/pub?gid=708970016&single=true&output=csv">Banawa Selatan</option>
  <option value="Rio Pakava" data-endpoint="">Rio Pakava</option>
  <option value="Pinembani" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vQshgCYmG0DHxcwLUzhtUamXTYnWb8tR7WQwnJq9k7ldFz_JhV4GHDE-k_dMO_pSA/pub?gid=1860451546&single=true&output=csv">Pinembani</option>
  <option value="Tanantovea" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vR3MhjBMD3q8UIfOTdAUOHKMdeGcwr3y2YQGFcDmHDd0IVsOsAECl511LsNJ9ynow9cmY4yBpP1jENa/pub?gid=1200528899&single=true&output=csv">Tanantovea</option>
  <option value="Labuan" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vT7WqNsmpUBIy0-lVm2JdGg1KUKwNgQPpbSyDuuFDwB1aGPY8gsZSBWmxIgiOeJNA/pub?gid=1615242439&single=true&output=csv">Labuan</option>
  <option value="Sindue" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2sjcmJjTCYD3p6-7pDQTmm3mCVphZIP2-5DGZOHxStucexMcdqPVsfsbnDouFcA/pub?gid=1920885371&single=true&output=csv">Sindue</option>
  <option value="Sindue Tombusabora" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vRYHOyrOQ_hNjC1L1FoIMVbbWES0dPGb1OaU6V--PV_lm0O97IHFvtPRhgRNXn_dA/pub?gid=1974330298&single=true&output=csv">Sindue Tombusabora</option>
  <option value="Sindue Tobata" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vQIbvzs-jZRcf1z0uV_Ahwh6dNdBgBHw66T358D9wd0-DHimDs8r4ajCvZwLa8Srg/pub?gid=801352666&single=true&output=csv">Sindue Tobata</option>
  <option value="Sirenja" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vROhU6H6reNQxHKsAmYYgfcaSZyis1vALTmBkYhjAp7BGX_wNdA2cVdgOjFQIIgjQ/pub?output=csv">Sirenja</option>
  <option value="Balaesang" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vQIf6mV6qgS6fmRe3jz305N8wCDdKWJcKKWSxHtybbo7xoERx15unD-x4rgyFxF-g/pub?gid=1401841928&single=true&output=csv">Balaesang</option>
  <option value="Balaesang Tanjung" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vQRojLHXJ4W6IEdiNn34kZrMgr5QvPZllm85-sbgD0WxjG6vFMUMQz3QzzGnM-7pw/pub?gid=820099832&single=true&output=csv">Balaesang Tanjung</option>
  <option value="Dampelas" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vR_BmCgfv-HOMRKzNMZ1aHL05CZsR7Ie0VZGRJTD29tX1C-ANiKASW1hB_PM69WuQ/pub?gid=1489077321&single=true&output=csv">Dampelas</option>
  <option value="Sojol" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vT64A3AbrmT4TK8fLj5ctUc3LLMESXVTOuw3nBd2qRTEFIljaxTBW3-Z5u4w7W2Ng/pub?gid=1781390946&single=true&output=csv">Sojol</option>
  <option value="Sojol Utara" data-endpoint="https://docs.google.com/spreadsheets/d/e/2PACX-1vT41KwECicPb2EY8d8BP1f73RM3dhVWYDOxpaFlHZluKFy9owLzyVX7N7mIUm37Tw/pub?gid=502544387&single=true&output=csv">Sojol Utara</option>
</select>

<label for="searchBarang">Cari Nama Barang:</label>
<input type="text" id="searchBarang" placeholder="Masukkan nama barang..."/>

<!-- Dashboard Per Kecamatan -->
<div class="dashboard">
  <div class="chart-container">
    <h2 class="chart-title">Konfirmasi Keberadaan</h2>
    <canvas id="chartKonfirmasi"></canvas>
  </div>
  <div class="chart-container">
    <h2 class="chart-title">Kondisi Barang</h2>
    <canvas id="chartKondisi"></canvas>
  </div>
</div>

<div class="chart-container" style="margin-top:15px;">
  <table id="dataTable">
    <thead>
      <tr>
        <th style="width:64px;">No</th>
        <th>Nama Barang</th>
        <th style="width:160px;">Konfirmasi</th>
        <th style="width:160px;">Kondisi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="pagination" id="pagination"></div>
</div>

<!-- Rekap Kabupaten -->
<div id="rekapKabupaten" style="display:none; margin-top:20px;">
  <div class="dashboard">
    <div class="chart-container">
      <h2 class="chart-title">Rekap Konfirmasi Kabupaten</h2>
      <canvas id="chartKabupatenKonfirmasi"></canvas>
    </div>
    <div class="chart-container">
      <h2 class="chart-title">Rekap Kondisi Kabupaten</h2>
      <canvas id="chartKabupatenKondisi"></canvas>
    </div>
  </div>

  <div class="chart-container" style="margin-top:15px;">
    <h2 class="chart-title">Tabel Rekap Per Kecamatan</h2>
    <table id="tabelRekapKecamatan">
      <thead>
        <tr>
          <th>Kecamatan</th>
          <th>Total Barang</th>
          <th>Ditemukan</th>
          <th>Tidak Ditemukan</th>
          <th>Baik</th>
          <th>Rusak Ringan</th>
          <th>Rusak Berat</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="muted" id="rekapNote" style="margin:6px 0 0;"></p>
  </div>
</div>

<script>
  // ======= State & Helpers =======
  let currentData = [];
  let filteredData = [];
  let currentPage = 1;
  const rowsPerPage = 8;

  let chartKonfirmasi, chartKondisi;
  let dataKabupaten = [];
  let chartKabupatenKonfirmasi, chartKabupatenKondisi;

  const btnRekap = document.getElementById("rekapKabupatenBtn");
  const rekapContainer = document.getElementById("rekapKabupaten");
  const statusInfo = document.getElementById("statusInfo");

  const KONFIRMASI_DEFAULT = "Tidak Ditemukan";
  const KONDISI_DEFAULT = "Baik";

  function setStatus(msg) {
    statusInfo.textContent = msg || "";
  }

  function cleanRows(rows) {
    // Hanya ambil baris yang memiliki setidaknya salah satu kolom terisi
    return rows.filter(r => {
      const values = Object.values(r || {});
      return values.some(v => (v ?? "").toString().trim() !== "");
    });
  }

  // ======= Dashboard per Kecamatan =======
  function updateDashboard() {
    const searchValue = document.getElementById("searchBarang").value.toLowerCase();
    filteredData = (currentData || []).filter(row =>
      (row["Nama Barang"] || "").toLowerCase().includes(searchValue)
    );
    currentPage = 1;
    renderTablePage(currentPage);
    renderCharts(filteredData);
  }

  function renderTablePage(page) {
    const tableBody = document.querySelector("#dataTable tbody");
    tableBody.innerHTML = "";
    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageData = filteredData.slice(start, end);

    pageData.forEach((row, index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${start + index + 1}</td>
        <td>${row["Nama Barang"] || "-"}</td>
        <td>${row["Konfirmasi Keberadaan"] || KONFIRMASI_DEFAULT}</td>
        <td>${row["Kondisi"] || KONDISI_DEFAULT}</td>
      `;
      tableBody.appendChild(tr);
    });
    renderPagination();
  }

  function renderPagination() {
    const totalPages = Math.ceil(filteredData.length / rowsPerPage) || 1;
    const paginationDiv = document.getElementById("pagination");
    paginationDiv.innerHTML = "";
    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.disabled = i === currentPage;
      if (i === currentPage) btn.classList.add("disabled");
      btn.addEventListener("click", () => { currentPage = i; renderTablePage(currentPage); });
      paginationDiv.appendChild(btn);
    }
  }

  function renderCharts(data) {
    const konfirmasiCounts = { Ditemukan: 0, [KONFIRMASI_DEFAULT]: 0 };
    const kondisiCounts = { Baik: 0, "Rusak Ringan": 0, "Rusak Berat": 0 };

    data.forEach(row => {
      const konfirmasi = row["Konfirmasi Keberadaan"] || KONFIRMASI_DEFAULT;
      const kondisi = row["Kondisi"] || KONDISI_DEFAULT;
      if (konfirmasiCounts[konfirmasi] !== undefined) konfirmasiCounts[konfirmasi]++;
      if (kondisiCounts[kondisi] !== undefined) kondisiCounts[kondisi]++;
    });

    const konfirmasiCtx = document.getElementById('chartKonfirmasi').getContext('2d');
    if (chartKonfirmasi) chartKonfirmasi.destroy();
    chartKonfirmasi = new Chart(konfirmasiCtx, {
      type: 'pie',
      data: {
        labels: Object.keys(konfirmasiCounts),
        datasets: [{ data: Object.values(konfirmasiCounts), backgroundColor: ['#3b82f6','#ef4444'] }]
      }
    });

    const kondisiCtx = document.getElementById('chartKondisi').getContext('2d');
    if (chartKondisi) chartKondisi.destroy();
    chartKondisi = new Chart(kondisiCtx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(kondisiCounts),
        datasets: [{ data: Object.values(kondisiCounts), backgroundColor: ['#10b981','#fbbf24','#ef4444'] }]
      }
    });
  }

  // Load satu kecamatan (dropdown)
  document.getElementById("filterKecamatan").addEventListener("change", function() {
    const url = this.selectedOptions[0]?.dataset?.endpoint || "";
    const kec = this.value || "";
    if (!url) { alert("Data belum tersedia untuk kecamatan ini."); return; }
    setStatus(`Memuat data kecamatan: ${kec} ...`);
    Papa.parse(url, {
      download: true,
      header: true,
      complete: function(results) {
        currentData = cleanRows(results.data || []);
        updateDashboard();
        setStatus(`Kecamatan ${kec}: ${currentData.length} baris data`);
      },
      error: function(err) {
        console.error(err);
        alert("Gagal memuat data kecamatan.");
        setStatus("");
      }
    });
  });

  document.getElementById("searchBarang").addEventListener("input", updateDashboard);

  // ======= Rekap Kabupaten (gabungan semua kecamatan) =======
  function loadAllKecamatanData(callback) {
    const options = document.querySelectorAll("#filterKecamatan option[data-endpoint]");
    let loaded = 0;
    let allData = [];
    const total = options.length;

    if (total === 0) return callback([]);

    options.forEach(opt => {
      const url = opt.dataset.endpoint;
      const kecamatan = opt.value;

      if (!url) { // endpoint kosong, tetap hitung selesai
        loaded++;
        if (loaded === total) callback(allData);
        return;
      }

      Papa.parse(url, {
        download: true,
        header: true,
        complete: function(results) {
          const rows = cleanRows(results.data || []).map(r => ({ ...r, Kecamatan: kecamatan }));
          allData.push(...rows);
          loaded++;
          setStatus(`Memuat rekap: ${loaded}/${total} kecamatan`);
          if (loaded === total) callback(allData);
        },
        error: function(err) {
          console.error(`Gagal memuat ${kecamatan}:`, err);
          loaded++;
          if (loaded === total) callback(allData);
        }
      });
    });
  }

  function renderRekapKabupaten(data) {
    const konfirmasiCounts = { Ditemukan: 0, [KONFIRMASI_DEFAULT]: 0 };
    const kondisiCounts = { Baik: 0, "Rusak Ringan": 0, "Rusak Berat": 0 };
    const perKecamatan = {};

    data.forEach(row => {
      const kec = row["Kecamatan"] || "-";
      const konfirmasi = row["Konfirmasi Keberadaan"] || KONFIRMASI_DEFAULT;
      const kondisi = row["Kondisi"] || KONDISI_DEFAULT;

      if (!perKecamatan[kec]) {
        perKecamatan[kec] = { total: 0, ditemukan: 0, tidak: 0, baik: 0, ringan: 0, berat: 0 };
      }
      perKecamatan[kec].total++;
      if (konfirmasi === "Ditemukan") perKecamatan[kec].ditemukan++; else perKecamatan[kec].tidak++;
      if (kondisi === "Baik") perKecamatan[kec].baik++;
      if (kondisi === "Rusak Ringan") perKecamatan[kec].ringan++;
      if (kondisi === "Rusak Berat") perKecamatan[kec].berat++;

      if (konfirmasiCounts[konfirmasi] !== undefined) konfirmasiCounts[konfirmasi]++;
      if (kondisiCounts[kondisi] !== undefined) kondisiCounts[kondisi]++;
    });

    // Charts Kabupaten
    const ctxK1 = document.getElementById('chartKabupatenKonfirmasi').getContext('2d');
    if (chartKabupatenKonfirmasi) chartKabupatenKonfirmasi.destroy();
    chartKabupatenKonfirmasi = new Chart(ctxK1, {
      type: 'pie',
      data: {
        labels: Object.keys(konfirmasiCounts),
        datasets: [{ data: Object.values(konfirmasiCounts), backgroundColor: ['#3b82f6','#ef4444'] }]
      }
    });

    const ctxK2 = document.getElementById('chartKabupatenKondisi').getContext('2d');
    if (chartKabupatenKondisi) chartKabupatenKondisi.destroy();
    chartKabupatenKondisi = new Chart(ctxK2, {
      type: 'doughnut',
      data: {
        labels: Object.keys(kondisiCounts),
        datasets: [{ data: Object.values(kondisiCounts), backgroundColor: ['#10b981','#fbbf24','#ef4444'] }]
      }
    });

    // Tabel Rekap Per Kecamatan (urut total desc)
    const tbody = document.querySelector("#tabelRekapKecamatan tbody");
    tbody.innerHTML = "";
    const rows = Object.entries(perKecamatan)
      .sort((a,b) => b[1].total - a[1].total || a[0].localeCompare(b[0])); // total desc, lalu nama

    rows.forEach(([kec, r]) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${kec}</td>
        <td>${r.total}</td>
        <td>${r.ditemukan}</td>
        <td>${r.tidak}</td>
        <td>${r.baik}</td>
        <td>${r.ringan}</td>
        <td>${r.berat}</td>
      `;
      tbody.appendChild(tr);
    });

    const note = document.getElementById("rekapNote");
    note.textContent = `Total baris data kabupaten: ${data.length}`;
  }

  // Toggle tombol Rekap Kabupaten
  btnRekap.addEventListener("click", () => {
    const visible = rekapContainer.style.display !== "none";
    if (visible) {
      // Sembunyikan
      rekapContainer.style.display = "none";
      btnRekap.textContent = "Lihat Rekap Kabupaten";
      setStatus("");
      return;
    }
    // Tampilkan
    rekapContainer.style.display = "block";
    btnRekap.textContent = "Sembunyikan Rekap Kabupaten";

    if (dataKabupaten.length > 0) {
      renderRekapKabupaten(dataKabupaten);
      return;
    }

    btnRekap.disabled = true;
    setStatus("Memuat rekap kabupaten...");
    loadAllKecamatanData(function(allData) {
      dataKabupaten = allData;
      renderRekapKabupaten(dataKabupaten);
      btnRekap.disabled = false;
      setStatus(`Rekap kabupaten termuat: ${dataKabupaten.length} baris`);
    });
  });

  // Inisialisasi awal (kosong)
  renderCharts([]);
</script>

</body>
</html>
